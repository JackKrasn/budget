# Логика финансирования расходов из фондов

## Концепция

Система позволяет финансировать расходы из виртуальных фондов. Фонды — это **учётные единицы**, которые позволяют отслеживать на что были потрачены накопления.

### Ключевые сущности

- **Фонд (Fund)** — виртуальный счёт для накоплений (отпуск, ремонт, резерв). Содержит активы (валюта, акции, облигации).
- **Счёт (Account)** — реальный банковский счёт или карта. Имеет флаги:
  - `is_credit = false` — дебетовая карта, обычный счёт
  - `is_credit = true` — кредитная карта (может уходить в минус)
  - `linked_fund_id` — фонд для автоматического резервирования (только для кредитных карт)
- **Резерв (Fund Reserve)** — запись о том, что средства фонда зарезервированы под расход с кредитной карты

### Важно понимать

Финансирование из фонда — это **только учётная операция**. Она показывает, что расход был оплачен из накоплений фонда, но **не создаёт реальных переводов между счетами**.

---

## Сценарий 1: Расход с дебетовой карты

### Исходное состояние

```
Счёт "Альфа Банк" (is_credit=false): 100 000₽

Фонд "Ремонт":
  - Баланс RUB: 30 000₽
```

### Шаг 1: Создание расхода

```bash
POST /api/v1/expenses
{
  "categoryId": "...",
  "amount": 5000,
  "currency": "RUB",
  "date": "2026-01-29",
  "description": "Покупка плитки",
  "accountId": "id-альфа-банк"
}
```

**Результат:**
```
Альфа Банк: 100 000 - 5 000 = 95 000₽
```

### Шаг 2: Финансирование из фонда (ручное)

```bash
POST /api/v1/expenses/{expense-id}/fund-allocations
{
  "fundId": "id-фонда-ремонт",
  "amount": 5000
}
```

**Что происходит:**
1. Проверка: достаточно средств в фонде (30 000 >= 5 000) ✓
2. Списание с валютного актива фонда: `Ремонт.RUB -= 5000` → 25 000₽
3. Баланс счёта расхода **НЕ меняется** — это только учёт

**Итоговое состояние:**
```
Альфа Банк: 95 000₽ (отражает реальный баланс в банке)
Фонд "Ремонт": 25 000₽ (учётный баланс)
```

---

## Сценарий 2: Расход с кредитной карты (ручное финансирование)

### Исходное состояние

```
Счёт "Альфа Кредитка" (is_credit=true): 0₽ (кредитный лимит 100 000₽)
Счёт "Тинькофф Дебет" (is_credit=false): 80 000₽

Фонд "Ремонт":
  - Баланс RUB: 30 000₽
```

### Шаг 1: Создание расхода

```bash
POST /api/v1/expenses
{
  "categoryId": "...",
  "amount": 10000,
  "currency": "RUB",
  "date": "2026-01-29",
  "description": "Покупка обоев",
  "accountId": "id-альфа-кредитка"
}
```

**Результат:**
```
Альфа Кредитка: 0 - 10 000 = -10 000₽ (долг)
```

### Шаг 2: Финансирование из фонда

```bash
POST /api/v1/expenses/{expense-id}/fund-allocations
{
  "fundId": "id-фонда-ремонт",
  "amount": 10000
}
```

**Что происходит:**
1. Проверка: достаточно средств в фонде (30 000 >= 10 000) ✓
2. Списание с валютного актива фонда: `Ремонт.RUB -= 10000` → 20 000₽
3. **Создание резерва** (т.к. счёт расхода КРЕДИТНЫЙ):
   ```sql
   INSERT INTO fund_reserves (fund_id, expense_id, amount, currency, status)
   VALUES ('id-ремонт', 'id-expense', 10000, 'RUB', 'pending')
   ```

**Итоговое состояние:**
```
Альфа Кредитка: -10 000₽ (долг остаётся)
Фонд "Ремонт": 20 000₽
Резервы: 10 000₽ pending
```

### Шаг 3: Погашение кредитной карты

```bash
POST /api/v1/accounts/{id-альфа-кредитка}/repay
{
  "fromAccountId": "id-тинькофф-дебет",
  "amount": 10000,
  "applyReserves": true
}
```

**Что происходит:**
1. Создаётся перевод: `Тинькофф Дебет -= 10000`, `Альфа Кредитка += 10000`
2. Резервы помечаются как `used` (в пределах суммы погашения)

**Итоговое состояние:**
```
Альфа Кредитка: 0₽ (долг погашен)
Тинькофф Дебет: 70 000₽
Фонд "Ремонт": 20 000₽
Резервы: использованы
```

---

## Сценарий 3: Автоматическое резервирование для кредитных карт

Для кредитных карт с привязанным фондом (`linked_fund_id`) система автоматически резервирует средства при каждом расходе.

### Настройка

```bash
# Привязать фонд к кредитной карте
PATCH /api/v1/accounts/{id-альфа-кредитка}
{
  "linkedFundId": "id-фонда-резерв-под-кредитку"
}
```

### Исходное состояние

```
Счёт "Альфа Кредитка":
  - is_credit=true
  - linked_fund_id → "Резерв под кредитку"
  - Баланс: 0₽

Фонд "Резерв под кредитку":
  - Баланс RUB: 100 000₽
```

### Создание расхода

```bash
POST /api/v1/expenses
{
  "categoryId": "...",
  "amount": 5000,
  "currency": "RUB",
  "date": "2026-01-29",
  "description": "Продукты",
  "accountId": "id-альфа-кредитка"
}
```

**Что происходит автоматически:**
1. Создаётся расход: `Альфа Кредитка -= 5000` → -5 000₽ (долг)
2. Создаётся резерв в привязанном фонде (fund_reserves)
3. Списание с фонда: `Резерв под кредитку.RUB -= 5000` → 95 000₽

**Итоговое состояние:**
```
Альфа Кредитка: -5 000₽ (долг)
Фонд "Резерв под кредитку": 95 000₽
Резервы: 5 000₽ pending
```

### Важно

- **Если у кредитки НЕ указан `linked_fund_id`** — создание расхода вернёт ошибку
- **Фонд может уйти в минус** — это сигнал о недостатке средств для покрытия расходов

---

## Частичное погашение резервов

При погашении кредитки резервы применяются в пределах суммы погашения.

**Пример:**
- Резервы: 11 000₽
- Погашение: 10 000₽

**Результат:**
- 10 000₽ из резервов помечаются как `used` (частично применённые)
- 1 000₽ остаются `pending` для следующего погашения

Поле `applied_amount` в `fund_reserves` отслеживает, сколько уже применено из каждого резерва.

---

## Удаление финансирования

### Для дебетовой карты

```bash
DELETE /api/v1/expenses/{id}/fund-allocations/{allocation-id}
```

**Что происходит:**
1. Возврат средств в валютный актив фонда: `Ремонт.RUB += amount`

### Для кредитной карты (резерв pending)

```bash
DELETE /api/v1/expenses/{id}/fund-allocations/{allocation-id}
```

**Что происходит:**
1. Возврат средств в фонд: `Ремонт.RUB += amount`
2. Удаление резерва (статус был `pending`)

### Для кредитной карты (резерв уже used)

```bash
DELETE /api/v1/expenses/{id}/fund-allocations/{allocation-id}

# Ответ: 409 Conflict
{
  "error": {
    "code": "CONFLICT",
    "message": "Резервы для этого расхода уже были использованы при погашении. Используйте параметр force=true для принудительного удаления."
  }
}
```

Принудительное удаление:

```bash
DELETE /api/v1/expenses/{id}/fund-allocations/{allocation-id}?force=true
```

**Что происходит:**
1. Возврат средств в фонд
2. Удаление резервов (даже used)

---

## API Endpoints

### Финансирование

| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/api/v1/expenses/{id}/fund-allocations` | Добавить финансирование |
| DELETE | `/api/v1/expenses/{id}/fund-allocations/{allocationId}` | Удалить финансирование |
| DELETE | `/api/v1/expenses/{id}/fund-allocations/{allocationId}?force=true` | Принудительное удаление |

### Резервы и погашение

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/v1/accounts/{id}/reserves` | Список pending резервов для счёта |
| POST | `/api/v1/accounts/{id}/apply-reserves` | Применить резервы (учётная операция) |
| POST | `/api/v1/accounts/{id}/repay` | Погасить кредитку с авто-применением резервов |

### Создание и настройка фонда

```bash
# Создать фонд
POST /api/v1/funds
{
  "name": "Отпуск",
  "isVirtual": true
}
```

### Настройка счёта

```bash
# Пометить счёт как кредитный
PATCH /api/v1/accounts/{id}
{
  "isCredit": true
}

# Привязать фонд для автоматического резервирования (только для кредитных карт)
PATCH /api/v1/accounts/{id}
{
  "linkedFundId": "id-фонда-резерв"
}
```

---

## Ограничения

1. **Нельзя финансировать больше, чем есть в фонде** — проверяется баланс валютного актива
2. **Нельзя финансировать расход без счёта** — расход должен быть привязан к `account_id`
3. **Удаление с used резервами требует force=true** — защита от случайных действий
4. **Для кредитных карт обязателен linked_fund_id** — иначе создание расхода вернёт ошибку
5. **linked_fund_id можно указать только для кредитных карт** — валидация при создании/обновлении счёта

---

## Схема базы данных

```sql
-- Флаг кредитного счёта и привязка к фонду для автоматического резервирования
ALTER TABLE accounts ADD COLUMN is_credit BOOLEAN NOT NULL DEFAULT FALSE;
ALTER TABLE accounts ADD COLUMN linked_fund_id UUID REFERENCES funds(id);

-- Таблица резервов
CREATE TABLE fund_reserves (
    id UUID PRIMARY KEY,
    fund_id UUID NOT NULL REFERENCES funds(id),
    expense_id UUID NOT NULL REFERENCES expenses(id),
    amount DECIMAL(20, 2) NOT NULL,
    applied_amount DECIMAL(20, 2) NOT NULL DEFAULT 0,  -- Для частичного применения
    currency VARCHAR(3) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'pending', -- pending, used, cancelled
    used_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```
